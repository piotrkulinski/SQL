--#region [DecryptUPO]
GO
IF OBJECT_ID (N'dbo.DecryptUPO') IS NOT NULL
   DROP PROCEDURE [dbo].[DecryptUPO]
go
print 'Tworze procedure tabelaryczna [DecryptUPO]'
/* 
exec [dbo].[DecryptUPO] @debug=1,@upo_base64='PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48UG90d2llcmR6ZW5pZSB4bWxucz0iaHR0cDovL3Vwby5zY2hlbWF0eS5tZi5nb3YucGwvS1NlRi92MSI+PE5hendhUG9kbWlvdHVQcnp5am11amFjZWdvPk1pbmlzdGVyc3R3byBGaW5hbnPDs3c8L05hendhUG9kbWlvdHVQcnp5am11amFjZWdvPjxOdW1lclJlZmVyZW5jeWpueT4yMDIzMDUxNy1TRS0xNDZFRTc2NTI4LUMxMTExMEY0QTktNjI8L051bWVyUmVmZXJlbmN5am55PjxJZGVudHlmaWthdG9yUG9kYXRrb3d5UG9kbWlvdHU+MTE0NzU4MTE1MzwvSWRlbnR5ZmlrYXRvclBvZGF0a293eVBvZG1pb3R1PjxTa3JvdFpsb3pvbmVqU3RydWt0dXJ5PlNMb1hKb3pqdi9NcmgvaE4zQXJ3Y25ZVm8wRnFha0FTQThlYkMzdlhWMGc9PC9Ta3JvdFpsb3pvbmVqU3RydWt0dXJ5PjxOYXp3YVN0cnVrdHVyeUxvZ2ljem5laj5GQSAxLTBFPC9OYXp3YVN0cnVrdHVyeUxvZ2ljem5laj48S29kRm9ybXVsYXJ6YT5GQSAoMSk8L0tvZEZvcm11bGFyemE+PERva3VtZW50PjxOdW1lcktTZUZEb2t1bWVudHU+MTE0NzU4MTE1My0yMDIzMDUxNy1FOTM5MzktNkY5M0I5LUUzPC9OdW1lcktTZUZEb2t1bWVudHU+PE51bWVyRmFrdHVyeT4yLzIwMjM8L051bWVyRmFrdHVyeT48RGF0YVByemVzbGFuaWFEb2t1bWVudHU+MjAyMy0wNS0xN1QyMToyNToyOS43NjIrMDI6MDA8L0RhdGFQcnplc2xhbmlhRG9rdW1lbnR1PjxEYXRhUHJ6eWplY2lhRG9rdW1lbnR1PjIwMjMtMDUtMTdUMjE6MjU6MjkuODg5KzAyOjAwPC9EYXRhUHJ6eWplY2lhRG9rdW1lbnR1PjxTa3JvdERva3VtZW50dT50RzhuVHphdGdrOEFheXNlK0hkOVNuNGJvL1dPcTFrUjhnOEtBZFNJbTRVPTwvU2tyb3REb2t1bWVudHU+PC9Eb2t1bWVudD48RG9rdW1lbnQ+PE51bWVyS1NlRkRva3VtZW50dT4xMTQ3NTgxMTUzLTIwMjMwNTE3LUU0OEM4OC05QjlBRUUtOTI8L051bWVyS1NlRkRva3VtZW50dT48TnVtZXJGYWt0dXJ5PjE2LzIwMjM8L051bWVyRmFrdHVyeT48RGF0YVByemVzbGFuaWFEb2t1bWVudHU+MjAyMy0wNS0xN1QyMToxNzo0Mi40NDErMDI6MDA8L0RhdGFQcnplc2xhbmlhRG9rdW1lbnR1PjxEYXRhUHJ6eWplY2lhRG9rdW1lbnR1PjIwMjMtMDUtMTdUMjE6MTc6NDIuNjgxKzAyOjAwPC9EYXRhUHJ6eWplY2lhRG9rdW1lbnR1PjxTa3JvdERva3VtZW50dT5mNk9qVnpJZDlxSDJjTTB3RUFDYVB4dkJ2MGJ1QXdyWXBTN1dnci9tY1djPTwvU2tyb3REb2t1bWVudHU+PC9Eb2t1bWVudD48RG9rdW1lbnQ+PE51bWVyS1NlRkRva3VtZW50dT4xMTQ3NTgxMTUzLTIwMjMwNTE3LUI4NjgwQy0wM0VGMUEtMjk8L051bWVyS1NlRkRva3VtZW50dT48TnVtZXJGYWt0dXJ5PjE1LzIwMjM8L051bWVyRmFrdHVyeT48RGF0YVByemVzbGFuaWFEb2t1bWVudHU+MjAyMy0wNS0xN1QyMTowMzoxNS40NzErMDI6MDA8L0RhdGFQcnplc2xhbmlhRG9rdW1lbnR1PjxEYXRhUHJ6eWplY2lhRG9rdW1lbnR1PjIwMjMtMDUtMTdUMjE6MDM6MTYuNzIzKzAyOjAwPC9EYXRhUHJ6eWplY2lhRG9rdW1lbnR1PjxTa3JvdERva3VtZW50dT4xVzFhWVliamhiaEFDNHhHRGphZkFub0kzNW91V1diQ2dobXREME80emJFPTwvU2tyb3REb2t1bWVudHU+PC9Eb2t1bWVudD48RG9rdW1lbnQ+PE51bWVyS1NlRkRva3VtZW50dT4xMTQ3NTgxMTUzLTIwMjMwNTE3LTA5QTQyRC0xMjM3NkMtMzQ8L051bWVyS1NlRkRva3VtZW50dT48TnVtZXJGYWt0dXJ5PjE0LzIwMjM8L051bWVyRmFrdHVyeT48RGF0YVByemVzbGFuaWFEb2t1bWVudHU+MjAyMy0wNS0xN1QyMToxMToyOS42NDQrMDI6MDA8L0RhdGFQcnplc2xhbmlhRG9rdW1lbnR1PjxEYXRhUHJ6eWplY2lhRG9rdW1lbnR1PjIwMjMtMDUtMTdUMjE6MTE6MjkuODAxKzAyOjAwPC9EYXRhUHJ6eWplY2lhRG9rdW1lbnR1PjxTa3JvdERva3VtZW50dT5zeXpGNE9SeFhmNkl6VEJBN0dUR3VZcE5VSUc5Y0QrV2hDaDlubXFLR3drPTwvU2tyb3REb2t1bWVudHU+PC9Eb2t1bWVudD48RG9rdW1lbnQ+PE51bWVyS1NlRkRva3VtZW50dT4xMTQ3NTgxMTUzLTIwMjMwNTE3LTczNkI0NS03ODRDOTctNTE8L051bWVyS1NlRkRva3VtZW50dT48TnVtZXJGYWt0dXJ5PjMvMjAyMzwvTnVtZXJGYWt0dXJ5PjxEYXRhUHJ6ZXNsYW5pYURva3VtZW50dT4yMDIzLTA1LTE3VDIxOjIxOjI5LjczNCswMjowMDwvRGF0YVByemVzbGFuaWFEb2t1bWVudHU+PERhdGFQcnp5amVjaWFEb2t1bWVudHU+MjAyMy0wNS0xN1QyMToyMToyOS44OTArMDI6MDA8L0RhdGFQcnp5amVjaWFEb2t1bWVudHU+PFNrcm90RG9rdW1lbnR1PnRxc1lxWGVBUlhkWmNsT0FKUUZmbFl4VGJMbnd4SHpIUTZOM3AyN0NNUE09PC9Ta3JvdERva3VtZW50dT48L0Rva3VtZW50PjxEb2t1bWVudD48TnVtZXJLU2VGRG9rdW1lbnR1PjExNDc1ODExNTMtMjAyMzA1MTctNkQ0QkNELTAxRkM4My1BNDwvTnVtZXJLU2VGRG9rdW1lbnR1PjxOdW1lckZha3R1cnk+MTcvMjAyMzwvTnVtZXJGYWt0dXJ5PjxEYXRhUHJ6ZXNsYW5pYURva3VtZW50dT4yMDIzLTA1LTE3VDIxOjE5OjM1LjE5NSswMjowMDwvRGF0YVByemVzbGFuaWFEb2t1bWVudHU+PERhdGFQcnp5amVjaWFEb2t1bWVudHU+MjAyMy0wNS0xN1QyMToxOTozNS4zNTgrMDI6MDA8L0RhdGFQcnp5amVjaWFEb2t1bWVudHU+PFNrcm90RG9rdW1lbnR1PlBsNWFmV1drTHZjR08rTzNleko2ajBvOFFTV0NNaWpveDdKdkRXcjNaU1k9PC9Ta3JvdERva3VtZW50dT48L0Rva3VtZW50PjxEb2t1bWVudD48TnVtZXJLU2VGRG9rdW1lbnR1PjExNDc1ODExNTMtMjAyMzA1MTctMkMzREVBLUZFOUVBRi04OTwvTnVtZXJLU2VGRG9rdW1lbnR1PjxOdW1lckZha3R1cnk+MTMvMjAyMzwvTnVtZXJGYWt0dXJ5PjxEYXRhUHJ6ZXNsYW5pYURva3VtZW50dT4yMDIzLTA1LTE3VDIxOjAwOjQ0LjMxNSswMjowMDwvRGF0YVByemVzbGFuaWFEb2t1bWVudHU+PERhdGFQcnp5amVjaWFEb2t1bWVudHU+MjAyMy0wNS0xN1QyMTowMDo0NS42MjkrMDI6MDA8L0RhdGFQcnp5amVjaWFEb2t1bWVudHU+PFNrcm90RG9rdW1lbnR1PmRkc0RVNWZyVFg2RTRLdW80VDFmQnh2cVZQZVpOR0dsdEdCYXQ0NE93NW89PC9Ta3JvdERva3VtZW50dT48L0Rva3VtZW50PjxkczpTaWduYXR1cmUgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiIElkPSJzaWdJZF8zMzMwNjY1Mzg3MTY2ODY0OCI+PGRzOlNpZ25lZEluZm8+PGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48ZHM6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIvPjxkczpSZWZlcmVuY2UgSWQ9Im1haW5SZWZJZF8zMzMwNjY1Mzg3MTY3MDM1MSIgVHlwZT0iIiBVUkk9IiI+PGRzOlRyYW5zZm9ybXM+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIi8+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8+PGRzOkRpZ2VzdFZhbHVlPnpxcm5TZE9uUm12RUJTK2ZXeEtGMk1KeXp3d1YvYmpIT3I5RTFmaHFZS1k9PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48ZHM6UmVmZXJlbmNlIFR5cGU9Imh0dHA6Ly91cmkuZXRzaS5vcmcvMDE5MDMjU2lnbmVkUHJvcGVydGllcyIgVVJJPSIjc2lnUHJvcElkXzMzMzA2NjUzODcxNjcwODgyIj48ZHM6VHJhbnNmb3Jtcz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PC9kczpUcmFuc2Zvcm1zPjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTYiLz48ZHM6RGlnZXN0VmFsdWU+S1o5THZwYVZiTGkzQ2NoR0p5cnBtd1ZEeU14TmVTOUI2dm9kZmhHRFIrcz08L2RzOkRpZ2VzdFZhbHVlPjwvZHM6UmVmZXJlbmNlPjwvZHM6U2lnbmVkSW5mbz48ZHM6U2lnbmF0dXJlVmFsdWUgSWQ9InNpZ1ZhbElkXzMzMzA2NjUzODcxNjY5NzcwIj5Vd2MyZzdYN0VYczZBR0VQeFJsZURBWGoyYlhtWnZzS0tKaEpaZjFmVXFHaVVuZHhvYndoNTRhV0NySmtkVXo5MHUwTktJK1ltTGVqcjFRUUhhQy9sNzRPWFdudCtZL2NwOFJ2U2piOGhtQTVPTEt0MnJhOGxzSmxuZUxjRWk0VE9EUCtxMm5DUjJjWUdNMUlsWDJqdTBuUU5UNW12OEFkOERVM1g1QVR0TTcvemZoVGp4WldRemlua3JRUUlFU3pia3NtZmZDM3JTM0NRa2R1WUhBVS9ucUZTeUIvZjd4UDZDSUZBOStCUmxyTm1Za3NiSkJNSk1id0ZSb2IwQmloVkJxamNDMFpPVDZqcDFCWlNwd2dLUXdTRlF3Rncxa3QzWkFwUlVBYlRtTVRhZWllT2JlcWRrMU4rQXlqNGpxMkdWT1JONk9YTXl1YjhZVXNrT0c2Ymc9PTwvZHM6U2lnbmF0dXJlVmFsdWU+PGRzOktleUluZm8+PGRzOlg1MDlEYXRhPjxkczpYNTA5Q2VydGlmaWNhdGU+TUlJSGxEQ0NCWHlnQXdJQkFnSVViMDhsNWQ3OE4zdmE2TVpGd1VGUmpKc0hlZ2d3RFFZSktvWklodmNOQVFFTEJRQXdmVEVMTUFrR0ExVUVCaE1DVUV3eEtEQW1CZ05WQkFvTUgwdHlZV3B2ZDJFZ1NYcGlZU0JTYjNwc2FXTjZaVzVwYjNkaElGTXVRUzR4S1RBbkJnTlZCQU1NSUVOUFVFVWdVMXBCUmtsU0lDMGdTM2RoYkdsbWFXdHZkMkZ1ZVNCVVJWTlVNUmt3RndZRFZRUmhFeEJXUVZSUVRDMDFNall3TXpBd05URTNNQjRYRFRJeE1Ea3hOVEV4TlRNeE4xb1hEVEl6TURreE5qRXhOVEkxTmxvd2dlSXhDekFKQmdOVkJBWVRBbEJNTVJRd0VnWURWUVFJREF0dFlYcHZkMmxsWTJ0cFpURVJNQThHQTFVRUJ3d0lWMkZ5YzNwaGQyRXhNekF4QmdOVkJBc01LbE42WldZZ1MzSmhhbTkzWldvZ1FXUnRhVzVwYzNSeVlXTnFhU0JUYTJGeVltOTNaV29nVkdWemRERVpNQmNHQTFVRVlRd1FWa0ZVVUV3dE5USTJNREkxTURJM05ERXNNQ29HQTFVRUNnd2pTM0poYW05M1lTQkJaRzFwYm1semRISmhZMnBoSUZOcllYSmliM2RoSUZSbGMzUXhMREFxQmdOVkJBTU1JMHR5WVdwdmQyRWdRV1J0YVc1cGMzUnlZV05xWVNCVGEyRnlZbTkzWVNCVVpYTjBNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQTJFeUhNNWdUWURXTk8vd1p5eWJTSGtqSlNxY3ZnVlRGSUdHTVZ5NE0zYjQ3Vmg3bTlsQ2JPZzlqTGZlaWE0dDZJUWkzTHBKVDc3VmFhV0hETG4xOVJ5MCsrWVpvanBUZnk4VGVuYTVtdWtQL3Jnd0kvVXhicGg2bEhRR3NFQlp1Q25lOTZJZEpLM0VBL3lIUTVPL1hrN3hLYmgwNnBna013aGZKMUVhSW1weVNqM09rNm5OZUhYWFc3aWVxYUFVZGx6bTN3QUZDY01vNzZnL2grMnNpMk53TUxGK0hiTkhVdG90NkgyK1pSSGpseXlTNGdZMHNuQmMxdlN4c0hDQlVBS3RkM0xYcCtxQWhuY2RRYmN6ZWphaXA1VElNYzJwaVdhUGwyN1pZVE9hc1MwQU9HUFR1MU9KOWoyWmpDTVdRTVo2M3BHTEQ0UE9RN3A5MWgzWEJ0UUlEQVFBQm80SUNwRENDQXFBd0RBWURWUjBUQVFIL0JBSXdBRENCeHdZRFZSMGdBUUgvQklHOE1JRzVNSUcyQmdrcWhHZ0JodmNqQVFFd2dhZ3dXZ1lJS3dZQkJRVUhBZ0l3VGd4TVEyVnlkSGxtYVd0aGRDQjNlV1JoYm5rZ2VtZHZaRzVwWlNCNklGcGh4WUxFaFdONmJtbHJhV1Z0SUVrZ1pHOGdVbTk2Y0c5eWVzU0ZaSHBsYm1saElHNXlJRGt4TUM4eU1ERTBMakJLQmdnckJnRUZCUWNDQVJZK2FIUjBjRG92TDNkM2R5NWxiR1ZyZEhKdmJtbGplbTU1Y0c5a2NHbHpMbkJzTDJsdVptOXliV0ZqYW1VdlpHOXJkVzFsYm5SNUxXa3RkVzF2ZDNrd2Z3WUlLd1lCQlFVSEFRTUVjekJ4TUFnR0JnUUFqa1lCQVRBSUJnWUVBSTVHQVFRd1JnWUdCQUNPUmdFRk1Ed3dPaFkwYUhSMGNITTZMeTkzZDNjdVpXeGxhM1J5YjI1cFkzcHVlWEJ2WkhCcGN5NXdiQzlRUzBsRWFYTmpiRzl6ZFhKbExuQmtaaE1DY0d3d0V3WUdCQUNPUmdFR01Ba0dCd1FBamtZQkJnTXdnWWtHQ0NzR0FRVUZCd0VCQkgwd2V6QXVCZ2dyQmdFRkJRY3dBWVlpYUhSMGNEb3ZMMjlqYzNBdVpXeGxhM1J5YjI1cFkzcHVlWEJ2WkhCcGN5NXdiREJKQmdnckJnRUZCUWN3QW9ZOWFIUjBjRG92TDNkM2R5NWxiR1ZyZEhKdmJtbGplbTU1Y0c5a2NHbHpMbkJzTDJObGNuUjVabWxyWVhSNUwyMXJkekl3TVRkMFpYTjBMbU55ZERBT0JnTlZIUThCQWY4RUJBTUNCYUF3SFFZRFZSMGxCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01COEdBMVVkSXdRWU1CYUFGSGdGY1B3UTh5WXRFUTY2eUlRUUNLNzVEUWJoTUVvR0ExVWRId1JETUVFd1A2QTlvRHVHT1doMGRIQTZMeTkzZDNjdVpXeGxhM1J5YjI1cFkzcHVlWEJ2WkhCcGN5NXdiQzlqY213dlkzSnNYMjFyZHpJd01UZDBaWE4wTG1OeWJEQWRCZ05WSFE0RUZnUVVna1JSdXVibFRSQ1dMbWpTUzg4SUl6ZHVheWd3RFFZSktvWklodmNOQVFFTEJRQURnZ0lCQUlRbzgzQWhQYzBQdS9sK1oxejVuMTJTdVRpREdYcFh1QkFZbHRoN29kcTZxSXFzUWpXNlUyZyt4eTVGZzZPN0RQOW5jdEZwTzNUbS9GbXdIdHpqZ21uTFdlcGpDdzFiaXREd2pYeW8veVhPdDFVM0d3dGRSeERvNmVteU1vMTBOeFhXcXNZM0t3bVBONm1KKzdraDEwYzhuRDNNTmw2Tk8weW5QRGZYQmM0YW9UeStJdEVxR1JQWitIdlNpQklmOXFXVjhFcGZQcWhqNjMwYlZ4VzRkYU5kYWNtYXRhYkQ3cmYzYlVGM3ZWa0dZWmxpcVNzUXhxRXJBalVEWTROSituK1VsOE5XaVY2MmIwV0s2TW82VGMxaVBBNktFYmhFalZheHBPdFlJYkkvb25yZkt1NGJrRjRVODhPeW5uaEQ3NW9WYzZBMHJqUG5vUEMzZ2hjeW5EbUZjdWs0ZEN0NXFrQmVtK0RkU2dDNUd2cmU3YUsyYi9jU1pzeEJSbGRrNHkrdER6eDlxb1ZPN3BOQURJcWQrVXVNMmVUcTk1VTFGNXUwWWpBaVh6NjRFcEtINGw3Y3JHcFp1dWlnaUIzZ1JySDRGY1ZaMkdHaFRvSkl5NDhhK0xuZkkzUmlVdnZtMGNEVGZ1UmFEc05HREp6dGJla3VTUkJFRUpwQTQxejliUEZvYTl4bFBnZktIMFBsVGVSVHh5ZDgvUmRmQTRHeklBek9WRzdQRGpxRWJFWktWN1FjQXFLVWtjU0Rvc1JLcWllUmVmWlNNcVF6Q2R3M1dXLy9QTFZRMk1YYUZEMVZZeUVvRVJFL0xEL1dKSXUrVTBHamhvbVZtVFlPMGI2Z01EekYwdVM3S1p3OWE0NFNlUm5yaEJTbzVtR1lmY2hYK1h6dytKT1ZPK1JOPC9kczpYNTA5Q2VydGlmaWNhdGU+PC9kczpYNTA5RGF0YT48L2RzOktleUluZm8+PGRzOk9iamVjdD48eGFkZXM6UXVhbGlmeWluZ1Byb3BlcnRpZXMgeG1sbnM6eGFkZXM9Imh0dHA6Ly91cmkuZXRzaS5vcmcvMDE5MDMvdjEuMy4yIyIgVGFyZ2V0PSIjc2lnSWRfMzMzMDY2NTM4NzE2Njg2NDgiPjx4YWRlczpTaWduZWRQcm9wZXJ0aWVzIElkPSJzaWdQcm9wSWRfMzMzMDY2NTM4NzE2NzA4ODIiPjx4YWRlczpTaWduZWRTaWduYXR1cmVQcm9wZXJ0aWVzPjx4YWRlczpTaWduaW5nVGltZT4yMDIzLTA1LTE3VDIzOjU4OjI4KzAyOjAwPC94YWRlczpTaWduaW5nVGltZT48eGFkZXM6U2lnbmluZ0NlcnRpZmljYXRlPjx4YWRlczpDZXJ0Pjx4YWRlczpDZXJ0RGlnZXN0PjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjc2hhMSIvPjxkczpEaWdlc3RWYWx1ZT5Nb25sSEdTTWtRc01zYnRNNW9zTXFwK2t3UDA9PC9kczpEaWdlc3RWYWx1ZT48L3hhZGVzOkNlcnREaWdlc3Q+PHhhZGVzOklzc3VlclNlcmlhbD48ZHM6WDUwOUlzc3Vlck5hbWU+T0lELjIuNS40Ljk3PVZBVFBMLTUyNjAzMDA1MTcsIENOPUNPUEUgU1pBRklSIC0gS3dhbGlmaWtvd2FueSBURVNULCBPPUtyYWpvd2EgSXpiYSBSb3psaWN6ZW5pb3dhIFMuQS4sIEM9UEw8L2RzOlg1MDlJc3N1ZXJOYW1lPjxkczpYNTA5U2VyaWFsTnVtYmVyPjYzNTQ2MzAzNTgwNzc2OTgwNTY2MDAzNzc4MDA2NjEyMTcxOTY3MTY0Nzg2MTI1NjwvZHM6WDUwOVNlcmlhbE51bWJlcj48L3hhZGVzOklzc3VlclNlcmlhbD48L3hhZGVzOkNlcnQ+PC94YWRlczpTaWduaW5nQ2VydGlmaWNhdGU+PC94YWRlczpTaWduZWRTaWduYXR1cmVQcm9wZXJ0aWVzPjx4YWRlczpTaWduZWREYXRhT2JqZWN0UHJvcGVydGllcz48eGFkZXM6RGF0YU9iamVjdEZvcm1hdCBPYmplY3RSZWZlcmVuY2U9IiNtYWluUmVmSWRfMzMzMDY2NTM4NzE2NzAzNTEiPjx4YWRlczpNaW1lVHlwZT50ZXh0L3htbDwveGFkZXM6TWltZVR5cGU+PC94YWRlczpEYXRhT2JqZWN0Rm9ybWF0PjwveGFkZXM6U2lnbmVkRGF0YU9iamVjdFByb3BlcnRpZXM+PC94YWRlczpTaWduZWRQcm9wZXJ0aWVzPjwveGFkZXM6UXVhbGlmeWluZ1Byb3BlcnRpZXM+PC9kczpPYmplY3Q+PC9kczpTaWduYXR1cmU+PC9Qb3R3aWVyZHplbmllPg=='
*/
/*
Procedura ma za zadanie rozparsowanie ciągu base64 w którym zostało zapisane UPO z KSeF
Rozparsowana treść jest przerzucana do tabeli typu UPODocuments i zwracana w wyniku.
Procedura wykorzystana w procedurze zapisującej respons z KSeF. Po wykryciu w response typu 'CommonStatusResponse'
następuje jego rozparsowanie i oznaczenie dokumentów.
<a href="file://C:\svn\trunk\sqlscript\KSEF\OnSaveResponse.sql"/>
*/
go
CREATE PROCEDURE [dbo].[DecryptUPO]  
(    
  @upo_base64 varchar(max) = ''
  ,@KodSystemowy int = 2
  ,@debug int = 0
) 
as 
begin
   declare 
       @upofk [UPODocuments]
      ,@upo xml

   SELECT @upo = CONVERT ( xml, CAST('' AS XML).value('xs:base64Binary(sql:column("BASE64_COLUMN"))', 'VARBINARY(MAX)') )
   FROM (SELECT @upo_base64 AS BASE64_COLUMN) b64
   if (@debug=1) begin
      select @upo
   end
   
   declare @KodFormularzaS varchar(10)

   ;with xmlnamespaces(default 'http://upo.schematy.mf.gov.pl/KSeF/v1')
   select 
    @KodFormularzaS = upo.value('(KodFormularza)[1]', 'varchar(10)')
   from @upo.nodes('/Potwierdzenie') B(upo)

   if ( @KodFormularzaS is null) begin
      ;with xmlnamespaces(default 'http://upo.schematy.mf.gov.pl/KSeF/v3')
      select 
      @KodFormularzaS = upo.value('(KodFormularza)[1]', 'varchar(10)')
      from @upo.nodes('/Potwierdzenie') B(upo)
   END
   if ( @KodFormularzaS is null) begin
      set @KodFormularzaS = 'FA (2)'
   end

   if (@KodFormularzaS='FA (1)') begin 
      set @KodSystemowy = 1
   end 
   else 
   if (@KodFormularzaS='FA (2)') begin
      set @KodSystemowy = 2
   end
   else begin 
      set @KodSystemowy = 0
   end
   --print @KodFormularzaS
   
   if (@KodSystemowy=1) begin
      ;with xmlnamespaces(default 'http://upo.schematy.mf.gov.pl/KSeF/v1')
      insert into @upofk
      select 
         upo.value('(../NumerReferencyjny)[1]', 'varchar(36)') 
         ,upo.value('(NumerFaktury)[1]', 'varchar(50)') 
         ,upo.value('(NumerKSeFDokumentu)[1]', 'varchar(36)') 
         ,upo.value('(DataPrzyjeciaDokumentu)[1]', 'datetime') 
      from @upo.nodes('/Potwierdzenie/Dokument') B(upo)
   end else begin 
      ;with xmlnamespaces(default 'http://upo.schematy.mf.gov.pl/KSeF/v3') -- niekonsekwencja KSeF
      insert into @upofk
      select 
         upo.value('(../NumerReferencyjny)[1]', 'varchar(36)') 
         ,upo.value('(NumerFaktury)[1]', 'varchar(50)') 
         ,upo.value('(NumerKSeFDokumentu)[1]', 'varchar(36)') 
         ,upo.value('(DataPrzyjeciaDokumentu)[1]', 'datetime') 
      from @upo.nodes('/Potwierdzenie/Dokument') B(upo)      
   end
   select [session],[NumerFaktury],[ksefReferenceNumber],[DataPrzyjeciaDokumentu]
   from @upofk

end
go